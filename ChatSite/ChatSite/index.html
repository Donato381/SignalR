<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Chat Room</title>

    <link type="text/css" rel="stylesheet" href="Css/ChatStyle.css" />
    <link href="Css/bootstrap.min.css" rel="stylesheet" />
    <link href="Css/bootstrap-theme.min.css" rel="stylesheet" />
    <link href="Css/font-awesome.min.css" rel="stylesheet" />

    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="/Scripts/jquery-1.10.2.min.js"></script>

    <!--Reference the bootstrap library. -->
    <script src="Scripts/bootstrap.min.js"></script>

    <!--Reference the SignalR library. -->
    <script src="/Scripts/jquery.signalR-2.1.2.min.js"></script>

    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>

    <style>
        .border {
            margin-bottom: 20px;
            background-color: #fff;
            border: 1px solid transparent;
            border-radius: 4px;
            border-color: #CCC;
            margin-right: 20px;
        }

        .media-heading {
            margin-top: 8px;
            margin-bottom: 5px;
        }

        .fa-user {
            color: #222;
            font-size: 30px;
        }
    </style>
</head>
<body>
    <div class="modal fade" tabindex="-1" role="dialog" id="Login">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    
                    <h4 class="modal-title">Join Chat Room</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <input type="text" class="form-control" placeholder="Username" id="txtNickName">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="btnStartChat">Join</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="container" style="margin-top:20px">
        <div class="row">

            <div class="conversation-wrap col-lg-3  border" style="padding:15px;height:530px; max-height:530px; overflow: auto " id="divusers">


            </div>



            <div class="message-wrap col-lg-8 border">
                <div class="msg-wrap " style="padding: 15px; height:400px; max-height:400px; overflow: auto " id="divChatWindow">


                </div>

                <div class="send-wrap ">

                    <textarea class="form-control send-message" id="txtMessage" rows="3" placeholder="Write a reply..."></textarea>


                </div>
                <div class="btn-panel">
                    <button type="button" class="btn btn-default pull-right" style="margin:10px 0" id="btnSendMsg"> Send Message</button>
                </div>
            </div>
        </div>
    </div>

    <input id="hdId" type="hidden" />
    <input id="hdUserName" type="hidden" />


    <script type="text/javascript">

        $(function () {

            setScreen(false);

            // Declare a proxy to reference the hub.
            var chatHub = $.connection.chatHub;

            registerClientMethods(chatHub);

            // Start Hub
            $.connection.hub.start().done(function () {

                registerEvents(chatHub)

            });

            
                $('#Login').on('hidden.bs.modal', function () {
                    $("#btnStartChat").click();
                })
           

            

        });

        function setScreen(isLogin) {

            if (!isLogin) {
                $('#Login').modal('show');

            }
            else {

                $("#divChat").show();
            }

        }

        function registerEvents(chatHub) {

            $("#btnStartChat").click(function () {

                $('#Login').modal('hide');

                var name = $("#txtNickName").val();
                if (name.length > 0) {
                    chatHub.server.connect(name);
                }
                else {
                    alert("Please enter your name");
                    $('#Login').modal('show');
                }

            });


            $('#btnSendMsg').click(function () {

                var msg = $("#txtMessage").val();
                if (msg.length > 0) {

                    var userName = $('#hdUserName').val();
                    chatHub.server.sendMessageToAll(userName, msg);
                    $("#txtMessage").val('');
                }
            });


            $("#txtNickName").keypress(function (e) {
                if (e.which == 13) {
                    $("#btnStartChat").click();
                }
            });

            $("#txtMessage").keypress(function (e) {
                if (e.which == 13) {
                    $('#btnSendMsg').click();
                }
            });


        }

        function registerClientMethods(chatHub) {

            // Calls when user successfully logged in
            chatHub.client.onConnected = function (id, userName, allUsers, messages) {

                setScreen(true);

                $('#hdId').val(id);
                $('#hdUserName').val(userName);
                $('#spanUser').html(userName);

                // Add All Users
                for (i = 0; i < allUsers.length; i++) {

                    AddUser(chatHub, allUsers[i].ConnectionId, allUsers[i].UserName);
                }

                // Add Existing Messages
                for (i = 0; i < messages.length; i++) {

                    AddMessage(messages[i].UserName, messages[i].MessageContent, messages[i].MessageTime);
                }


            }

            // On New User Connected
            chatHub.client.onNewUserConnected = function (id, name) {

                AddUser(chatHub, id, name);
            }


            // On User Disconnected
            chatHub.client.onUserDisconnected = function (id, userName) {

                $('#' + id).remove();

                var disc = $('<div class="alert alert-danger" role="alert">' + userName + ' logged off.</div>');

                $(disc).hide();
                $('#divusers').prepend(disc);
                $(disc).fadeIn(200).delay(2000).fadeOut(200);

            }

            chatHub.client.messageReceived = function (userName, message, CurrentTime) {

                AddMessage(userName, message, CurrentTime);
            }

        }

        function AddUser(chatHub, id, name) {

            var userId = $('#hdId').val();

            var code = "";

            if (userId == id) {

                code = $('<div class="media conversation" id="' + id + '"><a class="pull-left" href="#"><i class="fa fa-user" aria-hidden="true" ></i></a><div class="media-body" ><h5 class="media-heading">' + name + '</h5></div></div>');
            }
            else {

                code = $('<div class="media conversation" id="' + id + '"><a class="pull-left" href="#"><i class="fa fa-user" aria-hidden="true" ></i></a><div class="media-body"><h5 class="media-heading">' + name + '</h5></div></div>');
            }

            $("#divusers").append(code);

        }

        function AddMessage(userName, message, CurrentTime) {

            $('#divChatWindow').append('<div class="media msg"><a class="pull-left" href="#"><i class="fa fa-user" aria-hidden="true"></i></a><div class="media-body"><small class="pull-right time"><i class="fa fa-clock-o"></i> ' + CurrentTime + '</small><h5 class="media-heading">' + userName + '</h5><small class="col-lg-10">' + message + '</small></div></div>');

            var height = $('#divChatWindow')[0].scrollHeight;
            $('#divChatWindow').scrollTop(height);
        }


    </script>
</body>
</html>
